{"changed":true,"filter":false,"title":"server.js","tooltip":"/server.js","value":"//\n// # SimpleServer\n//\n// A simple chat server using Socket.IO, Express, and Async.\n//\n\n\n//var randomPiece = Math.random() * pieces.length;\n\nvar pieces = [];\n\nvar viewerSockets=[];\n\nvar totalPieces=36;\n\nfor (var i=0;i<totalPieces;i++){\n  var np=new Object();\n  np.index=i;\n  np.locked=false;\n  np.player=\"\";\n  pieces.push(np);\n}\n\nfunction lockPiece(id) {\n  pieces[id].locked=true;\n}\n\nfunction getPiece(name) {\n  \n  for (var j=0;j<pieces.length;j++) {\n    if (pieces[j].name==name) {\n      pieces[j].name=\"\";\n    }\n  }\n  \n  var p=[];\n  \n  for (var i=0;i<pieces.length;i++) {\n    if (pieces[i].locked==false) {\n      if (pieces[i].player==\"\") {\n        p.push(i);\n      }\n    }\n  }\n  \n  if (p.length<1) return -1;\n  \n  // console.log(p);\n  \n  var jj=Math.floor(Math.random()*p.length);\n  \n  pieces[ p[jj] ].player=name;\n  //console.log(\"array inside array\" + name);\n  return p[jj];\n}\n\n\n// var https = require('https');\n// var path = require('path');\n\n// var async = require('async');\n// var socketio = require('socket.io');\n// var express = require('express');\n// var router = express();\n// //var server = https.createServer(router);\n\n// //var io = socketio.listen(server);\n\n// router.use(express.static(path.resolve(__dirname, 'client')));\n\n// --------------------Secure server code begin\n\nvar https = require('https');\nvar path = require('path');\n\nvar async = require('async');\nvar socketio = require('socket.io');\nvar express = require('express');\nvar router = express();\nvar fs = require('fs');\nvar options = {\n  key: fs.readFileSync('/etc/letsencrypt/live/www.tackney.com/privkey.pem'),\n  cert: fs.readFileSync('/etc/letsencrypt/live/www.tackney.com/cert.pem')\n};\nvar app = require('https').createServer(options, handler);\nvar io = require('socket.io').listen(app);\nrouter.use(express.static(path.resolve(__dirname, 'client')));\n// var fs = require('fs');\n// var https = require('https');\n// var app = require('express')();\n// var options = {\n//   key  : fs.readFileSync('server.key'),\n//   cert : fs.readFileSync('server.crt')\n// };\n// app.get('/', function (req, res) {\n//   res.send('Secure World!');\n// });\n// https.createServer(options, app).listen(3000, function () {\n//   console.log('Started!');\n// });\n\n// --------------------Secure server code END\n\n\n\nvar sockets = [];\n\nvar viewerSocket = null;\n\nio.on('connection', function (socket) {\n\n    socket.emit('connect', \"test\");\n\n    sockets.push(socket);\n\n    socket.on('disconnect', function () {\n      sockets.splice(sockets.indexOf(socket), 1);\n        for (var j=0;j<pieces.length;j++) {\n          pieces[j].name=\"\";\n        }\n    });\n    \n    socket.on('VIEWER_LOGON', function () {\n      //viewerSocket = socket;\n      viewerSockets.push(socket);\n    });\n\n    socket.on('LOCK_PIECE', function (data) {\n      lockPiece(data);\n    });\n    \n    socket.on('DROP_PIECE', function (data) {\n      pieces[data].player=\"\";\n     // console.log(JSON.stringify(pieces));\n    });    \n    \n    socket.on('NEW_PIECE', function(data) {\n      \n      var whatPiece = -1;\n      \n      if (data.index>=0) pieces[data.index].player=\"\";\n      \n      whatPiece=getPiece(data.player);\n      \n      socket.emit(\"PLAYER_PIECE\", whatPiece);\n      \n        for (var i=0;i<viewerSockets.length;i++){\n          if (viewerSockets[i]) viewerSockets[i].emit('PLAYER_DATA',{'player':data.player,'piece':whatPiece } );\n        }      \n      \n    });\n    \n    socket.on('LOGON', function (user){\n        //if (viewerSocket) viewerSocket.emit('PLAYER', user);\n        \n        for (var i=0;i<viewerSockets.length;i++){\n          if (viewerSockets[i]) viewerSockets[i].emit('PLAYER',user);\n        }\n        // var data= {'player':user, 'index': getPiece(user)}\n        // socket.emit(\"PLAYER_PIECE\", data);\n    });\n    \n    socket.on('PLAYER_MOVE', function (data){\n       //if (viewerSocket) viewerSocket.emit('MOVE_PLAYER', data);\n       \n        for (var i=0;i<viewerSockets.length;i++){\n          if (viewerSockets[i]) viewerSockets[i].emit('MOVE_PLAYER', data);\n        }       \n    });    \n    \n  });\n\napp.listen(process.env.PORT || 3000, process.env.IP || \"0.0.0.0\", function(){\n  var addr = app.address();\n  console.log(\"Chat server listening at\", addr.address + \":\" + addr.port);\n});\n","undoManager":{"mark":-2,"position":100,"stack":[[{"start":{"row":70,"column":26},"end":{"row":70,"column":27},"action":"insert","lines":["u"],"id":187}],[{"start":{"row":70,"column":27},"end":{"row":70,"column":28},"action":"insert","lines":["r"],"id":188}],[{"start":{"row":70,"column":28},"end":{"row":70,"column":29},"action":"insert","lines":["e"],"id":189}],[{"start":{"row":70,"column":29},"end":{"row":70,"column":30},"action":"insert","lines":[" "],"id":190}],[{"start":{"row":70,"column":30},"end":{"row":70,"column":31},"action":"insert","lines":["s"],"id":191}],[{"start":{"row":70,"column":31},"end":{"row":70,"column":32},"action":"insert","lines":["e"],"id":192}],[{"start":{"row":70,"column":32},"end":{"row":70,"column":33},"action":"insert","lines":["r"],"id":193}],[{"start":{"row":70,"column":33},"end":{"row":70,"column":34},"action":"insert","lines":["v"],"id":194}],[{"start":{"row":70,"column":34},"end":{"row":70,"column":35},"action":"insert","lines":["e"],"id":195}],[{"start":{"row":70,"column":35},"end":{"row":70,"column":36},"action":"insert","lines":["r"],"id":196}],[{"start":{"row":70,"column":36},"end":{"row":70,"column":37},"action":"insert","lines":[" "],"id":197}],[{"start":{"row":70,"column":37},"end":{"row":70,"column":38},"action":"insert","lines":["c"],"id":198}],[{"start":{"row":70,"column":38},"end":{"row":70,"column":39},"action":"insert","lines":["o"],"id":199}],[{"start":{"row":70,"column":39},"end":{"row":70,"column":40},"action":"insert","lines":["d"],"id":200}],[{"start":{"row":70,"column":40},"end":{"row":70,"column":41},"action":"insert","lines":["e"],"id":201}],[{"start":{"row":70,"column":41},"end":{"row":70,"column":42},"action":"insert","lines":[" "],"id":202}],[{"start":{"row":70,"column":42},"end":{"row":70,"column":43},"action":"insert","lines":["E"],"id":203}],[{"start":{"row":70,"column":43},"end":{"row":70,"column":44},"action":"insert","lines":["N"],"id":204}],[{"start":{"row":70,"column":44},"end":{"row":70,"column":45},"action":"insert","lines":["D"],"id":205}],[{"start":{"row":68,"column":47},"end":{"row":69,"column":0},"action":"insert","lines":["",""],"id":206}],[{"start":{"row":69,"column":0},"end":{"row":70,"column":0},"action":"insert","lines":["",""],"id":207}],[{"start":{"row":70,"column":0},"end":{"row":71,"column":0},"action":"insert","lines":["",""],"id":208}],[{"start":{"row":71,"column":0},"end":{"row":78,"column":0},"action":"insert","lines":["var fs = require('fs');","var https = require('https');","var app = require('express')();","var options = {","   key  : fs.readFileSync('server.key'),","   cert : fs.readFileSync('server.crt')","};",""],"id":209}],[{"start":{"row":78,"column":0},"end":{"row":80,"column":3},"action":"insert","lines":["https.createServer(options, app).listen(3000, function () {","   console.log('Started!');","});"],"id":210}],[{"start":{"row":77,"column":2},"end":{"row":78,"column":0},"action":"insert","lines":["",""],"id":211}],[{"start":{"row":78,"column":0},"end":{"row":80,"column":3},"action":"insert","lines":["app.get('/', function (req, res) {","   res.send('Hello World!');","});"],"id":212}],[{"start":{"row":79,"column":13},"end":{"row":79,"column":25},"action":"remove","lines":["Hello World!"],"id":213},{"start":{"row":79,"column":13},"end":{"row":79,"column":14},"action":"insert","lines":["S"]}],[{"start":{"row":79,"column":14},"end":{"row":79,"column":15},"action":"insert","lines":["e"],"id":214}],[{"start":{"row":79,"column":15},"end":{"row":79,"column":16},"action":"insert","lines":["c"],"id":215}],[{"start":{"row":79,"column":16},"end":{"row":79,"column":17},"action":"insert","lines":["u"],"id":216}],[{"start":{"row":79,"column":17},"end":{"row":79,"column":18},"action":"insert","lines":["r"],"id":217}],[{"start":{"row":79,"column":18},"end":{"row":79,"column":19},"action":"insert","lines":["e"],"id":218}],[{"start":{"row":79,"column":19},"end":{"row":79,"column":20},"action":"insert","lines":[" "],"id":219}],[{"start":{"row":79,"column":20},"end":{"row":79,"column":21},"action":"insert","lines":["W"],"id":220}],[{"start":{"row":79,"column":21},"end":{"row":79,"column":22},"action":"insert","lines":["o"],"id":221}],[{"start":{"row":79,"column":22},"end":{"row":79,"column":23},"action":"insert","lines":["r"],"id":222}],[{"start":{"row":79,"column":23},"end":{"row":79,"column":24},"action":"insert","lines":["l"],"id":223}],[{"start":{"row":79,"column":24},"end":{"row":79,"column":25},"action":"insert","lines":["d"],"id":224}],[{"start":{"row":79,"column":25},"end":{"row":79,"column":26},"action":"insert","lines":["!"],"id":225}],[{"start":{"row":5,"column":0},"end":{"row":10,"column":33},"action":"remove","lines":["var https = require('https');","var path = require('path');","","var async = require('async');","var socketio = require('socket.io');","var express = require('express');"],"id":226}],[{"start":{"row":55,"column":0},"end":{"row":56,"column":0},"action":"insert","lines":["",""],"id":227}],[{"start":{"row":56,"column":0},"end":{"row":57,"column":0},"action":"insert","lines":["",""],"id":228}],[{"start":{"row":57,"column":0},"end":{"row":62,"column":33},"action":"insert","lines":["var https = require('https');","var path = require('path');","","var async = require('async');","var socketio = require('socket.io');","var express = require('express');"],"id":229}],[{"start":{"row":70,"column":47},"end":{"row":71,"column":0},"action":"remove","lines":["",""],"id":230}],[{"start":{"row":57,"column":0},"end":{"row":57,"column":3},"action":"insert","lines":["// "],"id":231},{"start":{"row":58,"column":0},"end":{"row":58,"column":3},"action":"insert","lines":["// "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":3},"action":"insert","lines":["// "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":3},"action":"insert","lines":["// "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":3},"action":"insert","lines":["// "]}],[{"start":{"row":72,"column":0},"end":{"row":72,"column":3},"action":"insert","lines":["// "],"id":232},{"start":{"row":73,"column":0},"end":{"row":73,"column":3},"action":"insert","lines":["// "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":3},"action":"insert","lines":["// "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":3},"action":"insert","lines":["// "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":2},"action":"insert","lines":["//"]},{"start":{"row":77,"column":0},"end":{"row":77,"column":2},"action":"insert","lines":["//"]},{"start":{"row":78,"column":0},"end":{"row":78,"column":3},"action":"insert","lines":["// "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":3},"action":"insert","lines":["// "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":2},"action":"insert","lines":["//"]},{"start":{"row":81,"column":0},"end":{"row":81,"column":3},"action":"insert","lines":["// "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":3},"action":"insert","lines":["// "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":2},"action":"insert","lines":["//"]},{"start":{"row":84,"column":0},"end":{"row":84,"column":3},"action":"insert","lines":["// "]}],[{"start":{"row":57,"column":0},"end":{"row":57,"column":3},"action":"remove","lines":["// "],"id":233},{"start":{"row":58,"column":0},"end":{"row":58,"column":3},"action":"remove","lines":["// "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":3},"action":"remove","lines":["// "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":3},"action":"remove","lines":["// "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":3},"action":"remove","lines":["// "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":3},"action":"remove","lines":["// "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":3},"action":"remove","lines":["// "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":3},"action":"remove","lines":["// "]},{"start":{"row":68,"column":0},"end":{"row":68,"column":3},"action":"remove","lines":["// "]}],[{"start":{"row":71,"column":0},"end":{"row":72,"column":0},"action":"insert","lines":["",""],"id":234}],[{"start":{"row":72,"column":0},"end":{"row":73,"column":0},"action":"insert","lines":["",""],"id":235}],[{"start":{"row":73,"column":0},"end":{"row":80,"column":0},"action":"insert","lines":["//var fs = require('fs');","//var options = {","//key: fs.readFileSync('/etc/letsencrypt/live/lostwords.org/privkey.pem'),","//cert: fs.readFileSync('/etc/letsencrypt/live/lostwords.org/cert.pem')","//};","//var app = require('https').createServer(options,handler),","//io = require('socket.io').listen(app);",""],"id":236}],[{"start":{"row":73,"column":0},"end":{"row":73,"column":2},"action":"remove","lines":["//"],"id":237},{"start":{"row":74,"column":0},"end":{"row":74,"column":2},"action":"remove","lines":["//"]},{"start":{"row":75,"column":0},"end":{"row":75,"column":2},"action":"remove","lines":["//"]},{"start":{"row":76,"column":0},"end":{"row":76,"column":2},"action":"remove","lines":["//"]},{"start":{"row":77,"column":0},"end":{"row":77,"column":2},"action":"remove","lines":["//"]},{"start":{"row":78,"column":0},"end":{"row":78,"column":2},"action":"remove","lines":["//"]},{"start":{"row":79,"column":0},"end":{"row":79,"column":2},"action":"remove","lines":["//"]}],[{"start":{"row":75,"column":0},"end":{"row":75,"column":2},"action":"insert","lines":["  "],"id":238}],[{"start":{"row":76,"column":0},"end":{"row":76,"column":2},"action":"insert","lines":["  "],"id":239}],[{"start":{"row":78,"column":48},"end":{"row":78,"column":55},"action":"remove","lines":["handler"],"id":240}],[{"start":{"row":78,"column":47},"end":{"row":78,"column":48},"action":"remove","lines":[","],"id":241}],[{"start":{"row":78,"column":48},"end":{"row":78,"column":49},"action":"remove","lines":[","],"id":242}],[{"start":{"row":78,"column":48},"end":{"row":78,"column":49},"action":"insert","lines":[";"],"id":243}],[{"start":{"row":79,"column":0},"end":{"row":79,"column":1},"action":"insert","lines":["v"],"id":244}],[{"start":{"row":79,"column":1},"end":{"row":79,"column":2},"action":"insert","lines":["a"],"id":245}],[{"start":{"row":79,"column":2},"end":{"row":79,"column":3},"action":"insert","lines":["r"],"id":246}],[{"start":{"row":79,"column":3},"end":{"row":79,"column":4},"action":"insert","lines":[" "],"id":247}],[{"start":{"row":66,"column":0},"end":{"row":66,"column":1},"action":"insert","lines":["/"],"id":248}],[{"start":{"row":66,"column":1},"end":{"row":66,"column":2},"action":"insert","lines":["/"],"id":249}],[{"start":{"row":64,"column":0},"end":{"row":64,"column":1},"action":"insert","lines":["/"],"id":250}],[{"start":{"row":64,"column":1},"end":{"row":64,"column":2},"action":"insert","lines":["/"],"id":251}],[{"start":{"row":72,"column":0},"end":{"row":78,"column":23},"action":"insert","lines":["var https = require('https');","var path = require('path');","","var async = require('async');","var socketio = require('socket.io');","var express = require('express');","var router = express();"],"id":252}],[{"start":{"row":86,"column":0},"end":{"row":86,"column":62},"action":"insert","lines":["router.use(express.static(path.resolve(__dirname, 'client')));"],"id":253}],[{"start":{"row":57,"column":0},"end":{"row":57,"column":3},"action":"insert","lines":["// "],"id":254},{"start":{"row":58,"column":0},"end":{"row":58,"column":3},"action":"insert","lines":["// "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":3},"action":"insert","lines":["// "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":3},"action":"insert","lines":["// "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":3},"action":"insert","lines":["// "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":3},"action":"insert","lines":["// "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":3},"action":"insert","lines":["// "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":3},"action":"insert","lines":["// "]},{"start":{"row":68,"column":0},"end":{"row":68,"column":3},"action":"insert","lines":["// "]}],[{"start":{"row":81,"column":46},"end":{"row":81,"column":59},"action":"remove","lines":["lostwords.org"],"id":255},{"start":{"row":81,"column":46},"end":{"row":81,"column":47},"action":"insert","lines":["w"]}],[{"start":{"row":81,"column":47},"end":{"row":81,"column":48},"action":"insert","lines":["w"],"id":256}],[{"start":{"row":81,"column":48},"end":{"row":81,"column":49},"action":"insert","lines":["w"],"id":257}],[{"start":{"row":81,"column":49},"end":{"row":81,"column":50},"action":"insert","lines":["."],"id":258}],[{"start":{"row":81,"column":50},"end":{"row":81,"column":51},"action":"insert","lines":["t"],"id":259}],[{"start":{"row":81,"column":51},"end":{"row":81,"column":52},"action":"insert","lines":["a"],"id":260}],[{"start":{"row":81,"column":52},"end":{"row":81,"column":53},"action":"insert","lines":["c"],"id":261}],[{"start":{"row":81,"column":53},"end":{"row":81,"column":54},"action":"insert","lines":["k"],"id":262}],[{"start":{"row":81,"column":54},"end":{"row":81,"column":55},"action":"insert","lines":["n"],"id":263}],[{"start":{"row":81,"column":55},"end":{"row":81,"column":56},"action":"insert","lines":["e"],"id":264}],[{"start":{"row":81,"column":56},"end":{"row":81,"column":57},"action":"insert","lines":["y"],"id":265}],[{"start":{"row":81,"column":57},"end":{"row":81,"column":58},"action":"insert","lines":[","],"id":266}],[{"start":{"row":81,"column":57},"end":{"row":81,"column":58},"action":"remove","lines":[","],"id":267}],[{"start":{"row":81,"column":57},"end":{"row":81,"column":58},"action":"insert","lines":["."],"id":268}],[{"start":{"row":81,"column":58},"end":{"row":81,"column":59},"action":"insert","lines":["c"],"id":269}],[{"start":{"row":81,"column":59},"end":{"row":81,"column":60},"action":"insert","lines":["o"],"id":270}],[{"start":{"row":81,"column":60},"end":{"row":81,"column":61},"action":"insert","lines":["m"],"id":271}],[{"start":{"row":82,"column":47},"end":{"row":82,"column":60},"action":"remove","lines":["lostwords.org"],"id":272},{"start":{"row":82,"column":47},"end":{"row":82,"column":62},"action":"insert","lines":["www.tackney.com"]}],[{"start":{"row":172,"column":0},"end":{"row":172,"column":6},"action":"remove","lines":["server"],"id":273},{"start":{"row":172,"column":0},"end":{"row":172,"column":1},"action":"insert","lines":["a"]}],[{"start":{"row":172,"column":1},"end":{"row":172,"column":2},"action":"insert","lines":["p"],"id":274}],[{"start":{"row":172,"column":2},"end":{"row":172,"column":3},"action":"insert","lines":["p"],"id":275}],[{"start":{"row":173,"column":13},"end":{"row":173,"column":19},"action":"remove","lines":["server"],"id":276},{"start":{"row":173,"column":13},"end":{"row":173,"column":14},"action":"insert","lines":["a"]}],[{"start":{"row":173,"column":14},"end":{"row":173,"column":15},"action":"insert","lines":["p"],"id":277}],[{"start":{"row":173,"column":15},"end":{"row":173,"column":16},"action":"insert","lines":["p"],"id":278}],[{"start":{"row":84,"column":47},"end":{"row":84,"column":48},"action":"insert","lines":[","],"id":279}],[{"start":{"row":84,"column":48},"end":{"row":84,"column":49},"action":"insert","lines":[" "],"id":280}],[{"start":{"row":84,"column":49},"end":{"row":84,"column":50},"action":"insert","lines":["h"],"id":281}],[{"start":{"row":84,"column":50},"end":{"row":84,"column":51},"action":"insert","lines":["a"],"id":282}],[{"start":{"row":84,"column":51},"end":{"row":84,"column":52},"action":"insert","lines":["n"],"id":283}],[{"start":{"row":84,"column":52},"end":{"row":84,"column":53},"action":"insert","lines":["d"],"id":284}],[{"start":{"row":84,"column":53},"end":{"row":84,"column":54},"action":"insert","lines":["l"],"id":285}],[{"start":{"row":84,"column":54},"end":{"row":84,"column":55},"action":"insert","lines":["e"],"id":286}],[{"start":{"row":84,"column":55},"end":{"row":84,"column":56},"action":"insert","lines":["r"],"id":287}]]},"ace":{"folds":[],"scrolltop":2264.200098991394,"scrollleft":0,"selection":{"start":{"row":172,"column":31},"end":{"row":172,"column":35},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":9,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1482372737716}